<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lensly ‚Äî Post</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .postWrap{max-width:980px;margin:0 auto;padding:18px}
    .postGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){.postGrid{grid-template-columns:1fr}}
    .panel{border:1px solid var(--border);background:var(--panel);border-radius:18px;padding:14px}
    .img{width:100%;max-height:560px;object-fit:cover;border-radius:14px;border:1px solid var(--border);display:block;background:#000}
    .row{display:flex;gap:10px;align-items:center}
    .row input{flex:1}
    .h2{margin:6px 0 2px;font-size:20px}
    .h3{margin:14px 0 8px}
    .comment{padding:8px 10px;border:1px solid var(--border);border-radius:14px;background:rgba(15,26,51,.6);margin:8px 0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">L</div>
      <div>
        <div class="brandTitle">Lensly</div>
        <div class="brandSub">Post details</div>
      </div>
    </div>
    <nav class="nav">
      <a class="link" href="./">Home</a>
      <a class="link" href="creator.html">Creator Upload</a>
    </nav>
  </header>

  <main class="postWrap">
    <div id="status" class="notice">Loading...</div>

    <div class="postGrid">
      <div class="panel">
        <img id="img" class="img" alt="post image"/>
      </div>

      <div class="panel">
        <div class="h2" id="title"></div>
        <div class="small muted" id="meta"></div>
        <p class="muted" id="caption" style="margin-top:10px;line-height:1.35"></p>

        <div class="h3">‚≠ê Rating</div>
        <div class="row">
          <input id="rating" placeholder="Enter 1-5">
          <button id="rateBtn">Submit</button>
        </div>

        <div class="h3">üí¨ Comment</div>
        <div class="row">
          <input id="comment" placeholder="Write a comment...">
          <button id="commentBtn">Send</button>
        </div>

        <div id="msg" class="small muted" style="margin-top:10px"></div>

        <div class="h3">Comments</div>
        <div id="comments"></div>
      </div>
    </div>
  </main>

  <script src="config.js"></script>
  <script>
    const id = new URLSearchParams(location.search).get("id");
    const statusEl = document.getElementById("status");
    const msgEl = document.getElementById("msg");

    function esc(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    async function api(path, opts){
      const res = await fetch(window.API_BASE + path, opts);
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function setStatus(kind, text){
      statusEl.className = "notice " + (kind||"");
      statusEl.textContent = text || "";
    }

    async function load(){
      try{
        if(!id) throw new Error("Missing id in URL");
        setStatus("", "Loading...");
        const p = await api(`/media/${encodeURIComponent(id)}`);

        document.getElementById("img").src = p.imageUrl;
        document.getElementById("title").textContent = p.title || "Untitled";
        document.getElementById("caption").textContent = p.caption || "";

        const stars = `‚≠ê ${(Number(p.avgRating||0)).toFixed(1)} (${p.ratingCount||0})`;
        const loc = p.location ? ` ‚Ä¢ ${p.location}` : "";
        document.getElementById("meta").textContent = `${stars}${loc}`;

        const list = (p.comments || []).map(c => `<div class="comment small">‚Ä¢ ${esc(c.text)}</div>`).join("");
        document.getElementById("comments").innerHTML = list || `<div class="small muted">No comments yet.</div>`;

        setStatus("good", "Loaded.");
      }catch(e){
        setStatus("bad", "Error: " + e);
      }
    }

    document.getElementById("commentBtn").onclick = async () => {
      try{
        msgEl.textContent = "Sending...";
        const text = document.getElementById("comment").value.trim();
        if(!text) throw new Error("Type a comment first");
        await api(`/media/${encodeURIComponent(id)}/comment`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text })
        });
        msgEl.textContent = "‚úÖ Comment added";
        document.getElementById("comment").value = "";
        await load();
      }catch(e){
        msgEl.textContent = "‚ùå " + e;
      }
    };

    document.getElementById("rateBtn").onclick = async () => {
      try{
        msgEl.textContent = "Rating...";
        const rating = Number(document.getElementById("rating").value);
        if(!(rating >= 1 && rating <= 5)) throw new Error("Rating must be 1..5");
        const r = await api(`/media/${encodeURIComponent(id)}/rate`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ rating })
        });
        msgEl.textContent = `‚úÖ Rated. Avg now: ${Number(r.avgRating).toFixed(2)} (${r.ratingCount})`;
        await load();
      }catch(e){
        msgEl.textContent = "‚ùå " + e;
      }
    };

    load();
  </script>
</body>
</html>
